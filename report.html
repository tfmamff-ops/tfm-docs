<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Informe de Verificación</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
            @bottom-center {
                content: "Página " counter(page) " de " counter(pages);
                font-size: 10px; color: #666; font-family: Arial;
            }
        }

        body { font-family: 'Arial', sans-serif; font-size: 11px; color: #333; }

        /* WATERMARK */
        .watermark {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 110px; font-weight: bold;
            color: rgba(200, 0, 0, 0.08); z-index: 9999;
            width: 100%; text-align: center;
        }

        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px;}
        
        th {
            background-color: #e8f5e9;
            color: #2E8B57;
            font-weight: bold;
            text-align: left;
            padding: 6px;
            border-bottom: 2px solid #2E8B57;
        }
        
        td {
            border-bottom: 1px solid #ddd;
            padding: 6px;
            vertical-align: top;
        }

        .key-col { font-weight: bold; width: 35%; background-color: #fafafa; }

        h2 {
            color: #2E8B57;
            border-bottom: 2px solid #2E8B57;
            font-size: 14px; margin-top: 20px; margin-bottom: 10px;
            text-transform: uppercase;
        }

        /* VALIDATION STYLES */
        .pass { color: #008000; font-weight: bold; }
        .fail { color: #cc0000; font-weight: bold; }

        /* IMAGES */
        .img-row td { text-align: center; padding: 10px; border: 1px solid #eee; }
        .img-row img {
            max-width: 95%; max-height: 400px;
            object-fit: contain; border: 1px solid #ccc;
        }
        .img-header { background-color: #2E8B57; color: white; text-align: center; padding: 4px; }

        /* SIGNATURES */
        .signature-box { margin-top: 50px;}
    </style>
</head>
<body>

    <div style="border-bottom: 3px solid #2E8B57; padding-bottom: 10px; margin-bottom: 20px;">
        <table style="margin:0;">
            <tr>
                <td style="border:none; width: 20%;">
					<svg xmlns="http://www.w3.org/2000/svg" width="63" height="55" viewBox="0 0 63 55">
					  <title>Rx logo (green circle, white letters)</title>
					  <circle cx="31.5" cy="26.5" r="24.5" fill="#00A541"/>
					  <text x="31.5" y="26.5"
							font-family="Inter, Arial, Helvetica, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Liberation Sans', sans-serif"
							font-weight="800"
							font-size="22"
							fill="#FFFFFF"
							text-anchor="middle"
							dominant-baseline="central"
							letter-spacing="0">
						Rx
					  </text>
					</svg>				
				</td>
				<td style="border:none; text-align:right; color:#2E8B57; font-size:16px; font-weight:bold; vertical-align: middle;">
					<div style="margin:0;">Informe de Verificación de Rotulado Farmacéutico</div>
					<div style="font-size: 10px; color: #888; font-weight: normal; margin-top: 4px;">
						© 2025 AGMCorp & Urbit
					</div>
				</td>
            </tr>
        </table>
    </div>

    <h2>Datos Generales</h2>
    <table>
        <tr><td class="key-col">Instancia</td><td>{{ instance_id }}</td></tr>
        <tr><td class="key-col">Fecha</td><td>{{ created_date }}</td></tr>
        <tr><td class="key-col">Hora</td><td>{{ created_time }}</td></tr>
        <tr><td class="key-col">Id usuario</td><td>{{ requested_by_user_id }}</td></tr>
        <tr><td class="key-col">Nombre</td><td>{{ requested_by_user_name }}</td></tr>
        <tr><td class="key-col">Email</td><td>{{ requested_by_user_email }}</td></tr>
        <tr><td class="key-col">Rol</td><td>{{ requested_by_user_role }}</td></tr>
        <tr><td class="key-col">Versión del software</td><td>{{ client_app_version }}</td></tr>
        <tr><td class="key-col">Código de producto</td><td>{{ expected_prod_code }}</td></tr>
        <tr><td class="key-col">Nombre del producto</td><td>{{ expected_prod_desc }}</td></tr>
    </table>

    <h2>Producto</h2>
    <table>
        <thead>
            <tr><th style="width: 33%;">Parámetro</th><th style="width: 33%;">Valor Esperado</th><th>Resultado</th></tr>
        </thead>
        <tbody>
            <tr>
                <td>Lote</td><td>{{ expected_lot }}</td>
                <td class="{{ 'pass' if validation_lot_ok else 'fail' }}">
                    {{ '✔ Correcto' if validation_lot_ok else '✘ Error' }}
                </td>
            </tr>
            <tr>
                <td>Fecha de vencimiento</td><td>{{ expected_exp_date }}</td>
                <td class="{{ 'pass' if validation_exp_date_ok else 'fail' }}">
                    {{ '✔ Correcto' if validation_exp_date_ok else '✘ Error' }}
                </td>
            </tr>
            <tr>
                <td>Fecha de envasado</td><td>{{ expected_pack_date }}</td>
                <td class="{{ 'pass' if validation_pack_date_ok else 'fail' }}">
                    {{ '✔ Correcto' if validation_pack_date_ok else '✘ Error' }}
                </td>
            </tr>
        </tbody>
    </table>

    <h2>Código de Barras</h2>
    <table>
        <tr><td class="key-col">Detectado</td>
            <td class="{{ 'pass' if validation_barcode_detected_ok else 'fail' }}">
                {{ '✔ Sí' if validation_barcode_detected_ok else '✘ No' }}
            </td>
        </tr>
        <tr><td class="key-col">Legible</td>
            <td class="{{ 'pass' if validation_barcode_legible_ok else 'fail' }}">
                {{ '✔ Sí' if validation_barcode_legible_ok else '✘ No' }}
            </td>
        </tr>
        <tr><td class="key-col">Valor decodificado</td><td>{{ barcode_payload_decoded_value }}</td></tr>
        <tr><td class="key-col">Simbología</td><td>{{ barcode_payload_barcode_symbology }}</td></tr>
    </table>

    <div style="page-break-before: always;"></div>
    <h2>Evidencias Visuales</h2>
    <table>
        <thead>
            <tr><th style="width: 30%;">Tipo</th><th style="width: 15%;">Contenedor</th><th>Ubicación</th></tr>
        </thead>
        <tbody>
            <tr><td>Imagen original</td><td>{{ input_container }}</td><td>{{ input_blob_name }}</td></tr>
            <tr><td>Imagen procesada</td><td>{{ processed_image_container }}</td><td>{{ processed_image_blob_name }}</td></tr>
            <tr><td>Región de OCR</td><td>{{ ocr_overlay_container }}</td><td>{{ ocr_overlay_blob_name }}</td></tr>
            <tr><td>Región de código de barras</td><td>{{ barcode_overlay_container }}</td><td>{{ barcode_overlay_blob_name }}</td></tr>
            <tr><td>Detalle de código de barras</td><td>{{ barcode_roi_container }}</td><td>{{ barcode_roi_blob_name }}</td></tr>
        </tbody>
    </table>

    <h2>Imágenes</h2>
    <table class="img-row">
        <tr><th class="img-header">Imagen original</th></tr>
        <tr><td>{% if input_image %}<img src="{{ input_image }}" style="width:500px;" alt="Imagen original">{% else %} No disponible {% endif %}</td></tr>
        
        <tr><th class="img-header">Imagen procesada</th></tr>
        <tr><td>{% if processed_image %}<img src="{{ processed_image }}" style="width:500px;" alt="Imagen procesada">{% else %} No disponible {% endif %}</td></tr>
        
        <tr><th class="img-header">Región de OCR</th></tr>
        <tr><td>{% if ocr_overlay_image %}<img src="{{ ocr_overlay_image }}" style="width:500px;" alt="Región de OCR">{% else %} No disponible {% endif %}</td></tr>
        
        <tr><th class="img-header">Región de código de barras</th></tr>
        <tr><td>{% if barcode_overlay_image %}<img src="{{ barcode_overlay_image }}" style="width:500px;" alt="Región de código de barras">{% else %} No disponible {% endif %}</td></tr>

        <tr><th class="img-header">Detalle de código de barras</th></tr>
        <tr><td>{% if barcode_roi_image %}<img src="{{ barcode_roi_image }}" style="width:500px;" alt="Detalle de código de barras">{% else %} No disponible {% endif %}</td></tr>
    </table>

    <div style="page-break-before: always;"></div>
        <h2>Resumen de Validaciones</h2>
        <table>
            <tr>
                <td>Coincidencia OCR con fuente autorizada</td>
                <td class="{{ 'pass' if validation_ocr_ok else 'fail' }}">
                    {{ '✔ Correcto' if validation_ocr_ok else '✘ Error' }}
                </td>
            </tr>
            <tr>
                <td>Validación de código de barras</td>
                <td class="{{ 'pass' if validation_barcode_ok else 'fail' }}">
                    {{ '✔ Correcto' if validation_barcode_ok else '✘ Error' }}
                </td>
            </tr>
			<tr style="background-color: {{ '#e8f5e9' if validation_summary else '#fdecea' }};">
				<td><strong>Verificación global</strong></td>
				<td class="{{ 'pass' if validation_summary else 'fail' }}">
					<strong>{{ '✔ APROBADO' if validation_summary else '✘ RECHAZADO' }}</strong>
				</td>
			</tr>
        </table>
    </div>

    <div class="signature-box">
        <h3>Observaciones del Operario</h3>
        <div style="border: 1px solid #999; padding: 10px; min-height: 50px; background: #f9f9f9;">
            {{ user_comment }}
        </div>

        <div style="margin-top: 40px; border-top: 1px solid #000; width: 60%; padding-top: 5px;">
            Firma del Operario
        </div>

        <p style="margin-top: 30px; font-size: 10px; color: #666;">
            Ubicación final del informe:<br>
            {{ report_container }} - {{ report_blob_name }}
        </p>
    </div>
	
    {% if not accepted %}
    <div class="watermark">RECHAZADO</div>
    {% endif %}
	
</body>
</html>